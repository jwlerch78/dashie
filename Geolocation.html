<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Family Location Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h1 {
      text-align: center;
    }
    .device-list {
      max-width: 400px;
      margin: 0 auto;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px;
    }
    .device {
      padding: 8px;
      border-bottom: 1px solid #eee;
    }
    .device:last-child {
      border-bottom: none;
    }
    .name {
      font-weight: bold;
    }
    .zone {
      margin-left: 10px;
      font-style: italic;
      color: #555;
    }
  </style>
</head>
<body>
  <h1>Family Location Dashboard</h1>
  <div class="device-list" id="deviceList"></div>

  <script>
    // ====== CONFIG ======
    const proxyUrl = "https://traccar-proxy-fcj3.onrender.com"; // replace with your proxy URL

    const devices = [
      { name: "Dad", id: 1 }
      // You can add more devices here
    ];

    // Define zones by coordinates (latitude/longitude)
    const zones = [
      { name: "Home", lat: 27.9123, lon: -82.7712, radius: 0.002 },
      { name: "High School", lat: 27.9150, lon: -82.7800, radius: 0.002 },
      { name: "Soccer Field", lat: 27.9200, lon: -82.7700, radius: 0.002 }
    ];

    function getZone(lat, lon) {
      for (let zone of zones) {
        const distance = Math.sqrt((lat - zone.lat)**2 + (lon - zone.lon)**2);
        if (distance <= zone.radius) return zone.name;
      }
      return "Other";
    }

    async function updateLocations() {
      const container = document.getElementById("deviceList");
      container.innerHTML = "";

      for (let device of devices) {
        try {
          const response = await fetch(`${proxyUrl}/positions/${device.id}`);
          const data = await response.json();

          let displayText = "No location available";

          // Handle array returned by Traccar
          if (Array.isArray(data) && data.length > 0) {
            const pos = data[0];
            if (pos.latitude && pos.longitude) {
              const zoneName = getZone(pos.latitude, pos.longitude);
              displayText = `Lat: ${pos.latitude.toFixed(5)}, Lon: ${pos.longitude.toFixed(5)} | ${zoneName}`;
            }
          }

          const div = document.createElement("div");
          div.className = "device";
          div.innerHTML = `<span class="name">${device.name}:</span> <span class="zone">${displayText}</span>`;
          container.appendChild(div);

        } catch (err) {
          console.error(`Error fetching ${device.name}:`, err);
          const div = document.createElement("div");
          div.className = "device";
          div.innerHTML = `<span class="name">${device.name}:</span> <span class="zone">Error fetching location</span>`;
          container.appendChild(div);
        }
      }
    }

    // Initial load
    updateLocations();

    // Refresh every 30 seconds
    setInterval(updateLocations, 30000);
  </script>
</body>
</html>
