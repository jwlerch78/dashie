<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Family Location Dashboard</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  body { font-family: Arial, sans-serif; margin: 0; background: #f5f5f5; }
  h1 { text-align: center; margin: 10px 0; }
  
  /* Family bar at the top */
  #family-bar {
    display: flex;
    justify-content: space-around;
    align-items: center;
    background: #fffdd0dd; /* light transparent cream */
    padding: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  }

  .member {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100px;
  }

  .member img {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    margin-bottom: 5px;
  }

  .name { font-weight: bold; }
  .location { font-size: 0.9em; color: #555; text-align: center; }

  /* Map styling */
  #map { height: 400px; width: 100%; margin-top: 10px; }
</style>
</head>
<body>

<h1>Family Location Dashboard</h1>

<!-- Family bar -->
<div id="family-bar">
  <div class="member" id="dad">
    <img src="https://raw.githubusercontent.com/jwlerch78/family_calendar/main/images/dad.png" alt="Dad">
    <div class="name">Dad</div>
    <div class="location" id="dad-location">Loading...</div>
  </div>
  <div class="member" id="mom">
    <img src="https://raw.githubusercontent.com/jwlerch78/family_calendar/main/images/mom.png" alt="Mom">
    <div class="name">Mom</div>
    <div class="location" id="mom-location">Work</div>
  </div>
  <div class="member" id="mary">
    <img src="https://raw.githubusercontent.com/jwlerch78/family_calendar/main/images/mary.png" alt="Mary">
    <div class="name">Mary</div>
    <div class="location" id="mary-location">Osceola</div>
  </div>
  <div class="member" id="charlie">
    <img src="https://raw.githubusercontent.com/jwlerch78/family_calendar/main/images/char.png" alt="Charlie">
    <div class="name">Charlie</div>
    <div class="location" id="charlie-location">CFMS</div>
  </div>
  <div class="member" id="jack">
    <img src="https://raw.githubusercontent.com/jwlerch78/family_calendar/main/images/jack.png" alt="Jack">
    <div class="name">Jack</div>
    <div class="location" id="jack-location">Soccer (Belcher)</div>
  </div>
</div>

<!-- Map -->
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const proxyUrl = "https://traccar-proxy-fcj3.onrender.com";

// Only Dad is live tracked for now
const devices = [{ name: "Dad", id: 1 }];

// Zones
const zones = [
  { name: "Home", lat: 27.93241, lon: -82.81062, radius: 0.002 },
  { name: "High School", lat: 27.9150, lon: -82.7800, radius: 0.002 },
  { name: "Soccer Field", lat: 27.9200, lon: -82.7700, radius: 0.002 }
];

function getZone(lat, lon) {
  for (let zone of zones) {
    const distance = Math.sqrt((lat - zone.lat)**2 + (lon - zone.lon)**2);
    if (distance <= zone.radius) return zone.name;
  }
  return "Other";
}

// Initialize Leaflet map
const map = L.map('map').setView([27.9123, -82.7712], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'Â© OpenStreetMap contributors'
}).addTo(map);

const markers = {};

async function reverseGeocode(lat, lon) {
  try {
    const resp = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
    const json = await resp.json();
    return json.address.city || json.address.town || json.address.village || json.display_name;
  } catch {
    return "Unknown location";
  }
}

async function updateLocations() {
  for (let device of devices) {
    try {
      const response = await fetch(`${proxyUrl}/positions/${device.id}`);
      const data = await response.json();

      if (Array.isArray(data) && data.length > 0) {
        const pos = data[0];
        if (pos.latitude && pos.longitude) {
          const zoneName = getZone(pos.latitude, pos.longitude);
          const readableLoc = await reverseGeocode(pos.latitude, pos.longitude);

          // Update family bar
          document.getElementById("dad-location").textContent = zoneName;

          // Update marker
          if (markers[device.id]) {
            markers[device.id].setLatLng([pos.latitude, pos.longitude]);
          } else {
            markers[device.id] = L.marker([pos.latitude, pos.longitude])
              .addTo(map)
              .bindPopup(`${device.name}: ${zoneName} | ${readableLoc}`)
              .openPopup();
          }

          map.setView([pos.latitude, pos.longitude], 13);
        }
      }
    } catch (err) {
      console.error(`Error fetching ${device.name}:`, err);
      document.getElementById("dad-location").textContent = "Error";
    }
  }
}

// Initial update and periodic refresh
updateLocations();
setInterval(updateLocations, 30000);
</script>

</body>
</html>
