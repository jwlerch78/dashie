<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Family Location Dashboard</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
  #map { height: 500px; width: 100%; }
  #locations { margin-top: 10px; font-family: sans-serif; }
</style>
</head>
<body>
<h2>Family Location Dashboard</h2>
<div id="map"></div>
<div id="locations"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// ----- CONFIG -----
const proxyUrl = "https://traccar-proxy-etet.onrender.com"; // your Render proxy
const devices = [
  { id: 20927366, name: "Dad" },
  // Add more devices here: {id: DEVICE_ID, name: "Name"}
];

const map = L.map('map').setView([27.915, -82.787], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

const markers = {};

// Reverse geocode coordinates to city/area name
async function getAreaName(lat, lon) {
  try {
    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
    const data = await res.json();
    return data.address.city || data.address.town || data.address.village || data.display_name;
  } catch (err) {
    console.error("Reverse geocoding error:", err);
    return "Unknown area";
  }
}

async function updateLocations() {
  const locationsDiv = document.getElementById('locations');
  locationsDiv.innerHTML = '';

  for (const device of devices) {
    try {
      const res = await fetch(`${proxyUrl}/positions/${device.id}`);
      const data = await res.json();
      if (!data || data.length === 0) continue;

      const pos = data[data.length - 1];
      const lat = pos.latitude;
      const lon = pos.longitude;

      // Add or update marker
      if (markers[device.id]) {
        markers[device.id].setLatLng([lat, lon]);
      } else {
        markers[device.id] = L.marker([lat, lon]).addTo(map)
          .bindPopup(`${device.name}`);
      }

      const areaName = await getAreaName(lat, lon);
      locationsDiv.innerHTML += `<strong>${device.name}</strong>: ${areaName} (${lat.toFixed(5)}, ${lon.toFixed(5)})<br>`;

    } catch (err) {
      console.error(`Error fetching ${device.name}:`, err);
    }
  }
}

updateLocations();
setInterval(updateLocations, 30000);
</script>
</body>
</html>
